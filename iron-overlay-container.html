<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="iron-overlay-manager.html">

<!--
`iron-overlay-container` stamps overlays to `document.body` in order to avoid
any stacking context issue that would cause clipping or rendering behind the backdrop element.
The rest of the content is distributed within `iron-overlay-container`.
Mark the template containing the overlay with the attribute `overlay`.

Example:

    <iron-overlay-container>
      <template overlay>
        <overlay-impl>
          dialog content...
        </overlay-impl>
      </template>
    </iron-overlay-container>

-->

<dom-module id="iron-overlay-container">

  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>
    <content></content>
  </template>

  <script>
    Polymer({

      is: 'iron-overlay-container',

      behaviors: [Polymer.Templatizer],

      properties: {
        /**
         * True to skip the stamping of the overlay on attached.
         * Delegates the call of `stampOverlay` to the user.
         */
        noAutoStamp: Boolean,

        /*
         * The overlay instance.
         * @type {Node}
         */
        overlay: {
          type: Object,
          readOnly: true,
          notify: true
        }
      },

      ready: function() {
        // Used for delaying the append into body.
        this.__instance = null;
        var template = this.queryEffectiveChildren('template[overlay]');
        if (!template) return;
        this.templatize(template);
        // Must stamp so overlay gets registered, and we can check if it is
        // an overlay or not!
        var inst = this.stamp(null);
        var overlay = this._getOverlay(inst.root.children);
        if (!overlay) {
          console.error('must use only with overlays!');
        } else {
          this.__instance = inst;
          this._setOverlay(overlay);
        }
      },

      attached: function() {
        if (!this.noAutoStamp) {
          this.stampOverlay();
        }
      },

      detached: function() {
        if (!this.overlay) {
          return;
        }
        var parentNode = Polymer.dom(this.overlay).parentNode;
        if (parentNode) {
          Polymer.dom(parentNode).removeChild(this.overlay);
        }
      },

      /**
       * Stamps the overlay to `document.body`.
       */
      stampOverlay: function() {
        if (!this.overlay) {
          return;
        }
        if (Polymer.dom(this.overlay).parentNode !== document.body) {
          Polymer.dom(document.body).appendChild(this.__instance.root);
        }
      },

      /**
       * Returns the first overlay of a list of elements.
       * @param {Array<Node>} elements
       * @returns {Node|undefined}
       */
      _getOverlay: function(elements) {
        for (var i = 0; i < elements.length; i++) {
          if (Polymer.IronOverlayManager.isOverlay(elements[i])) {
            return elements[i];
          }
        }
      },

      /**
       * Implements extension point from Templatizer.
       * Forward values to overlay instance.
       */
      _forwardParentProp: function(prop, value) {
        if (this.overlay) {
          this.overlay._templateInstance[prop] = value;
        }
      },
    });
  </script>

</dom-module>
