<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="iron-overlay-manager.html">

<dom-module id="iron-overlay-proxy">

  <template strip-whitespace>
    <style>
      :host {
        display: none;
      }
    </style>
    <template strip-whitespace>
      <content></content>
    </template>
  </template>

</dom-module>

<script>
  Polymer({

    is: 'iron-overlay-proxy',

    properties: {
      /**
       * The overlay to be proxied. Must be an element that extends IronOverlayBehavior.
       */
      overlay: {
        type: Object,
        observer: '_overlayChanged'
      },

      /**
       * The overlay id to be proxied. Will search for overlay in the document
       * on attached.
       */
      overlayId: {
        type: String,
        observer: '_overlayIdChanged'
      },

      opened: {
        type: Boolean,
        notify: true,
        observer: '_openChanged'
      },

      /**
       * Shortcut to access to the overlay manager.
       * @private
       * @type {Polymer.IronOverlayManagerClass}
       */
      _manager: {
        type: Object,
        value: Polymer.IronOverlayManager
      },

      __boundOverlayClosed: {
        type: Function,
        value: function() {
          return this.close.bind(this);
        }
      }
    },

    created: function() {
      this.__proxiedProperties = {};
      this.__thisChildren = [];
    },

    attached: function() {
      this.__thisChildren = this.getEffectiveChildren();
      if (!this.overlay && this.overlayId) {
        this._overlayIdChanged(this.overlayId);
      } else {
        this._overlayChanged(this.overlay);
      }
    },

    detached: function() {
      this.__resetProxiedProperties();
    },

    open: function() {
      this.opened = true;
    },

    close: function() {
      this.opened = false;
    },

    toggle: function() {
      this.opened = !this.opened;
    },

    _overlayIdChanged: function(overlayId) {
      if (!this.isAttached) {
        return;
      }
      this.overlay = Polymer.dom(document).querySelector('#' + overlayId);
    },

    _overlayChanged: function(overlay, oldOverlay) {
      if (!this.isAttached) {
        return;
      }
      if (overlay && !this._manager.isOverlay(overlay)) {
        console.error('Not an overlay!', overlay);
        return;
      }
      // Reset old properties.
      this.__resetProxiedProperties();
      // Proxy overlay properties & methods.
      this.__proxyOverlay();

      if (oldOverlay) {
        if (this.__thisChildren.length) {
          this.__stampContent(oldOverlay, this.__overlayChildren);
          this.__stampContent(this, this.__thisChildren);
        }
        oldOverlay.removeEventListener('iron-overlay-closed', this.__boundOverlayClosed);
      }
      if (overlay) {
        overlay.addEventListener('iron-overlay-closed', this.__boundOverlayClosed);
        this.__overlayChildren = Polymer.dom(overlay).children;
      }
    },

    _openChanged: function() {
      if (this.__thisChildren.length) {
        if (this.opened) {
          this.__stampContent(this.overlay, this.__thisChildren);
        } else {
          this.__stampContent(this.overlay, this.__overlayChildren);
          this.__stampContent(this, this.__thisChildren);
        }
      }
      this.overlay.opened = this.opened;
    },

    __resetProxiedProperties: function() {
      for (var prop in this.__proxiedProperties) {
        delete this[prop];
      }
      this.__proxiedProperties = {};
    },

    __proxyProperty: function(name) {
      // No duplicates.
      if (this.__proxiedProperties[name]) {
        return;
      }
      // Avoid setting things like `root`, `$`, `id`.
      if (name in this) {
        return;
      }

      Object.defineProperty(this, name, {
        get: function() {
          return this.overlay[name];
        },
        set: function(value) {
          this.overlay[name] = value;
        },
        enumerable: true,
        configurable: true
      });
      this.__proxiedProperties[name] = true;
    },

    __proxyOverlay: function() {
      if (!this.overlay) {
        return;
      }
      var properties = this.__getPropertyNames(this.overlay);
      for (var name in properties) {
        this.__proxyProperty(name);
        // Ensure property value is passed to the overlay.
        if (this.hasAttribute(name)) {
          var type = properties[name];
          this[name] = this.deserialize(this.getAttribute(name), type);
        }
      }
    },

    __getPropertyNames: function() {
      var result = {};
      // First, get behaviors
      var behaviors = this.overlay.behaviors || [];
      for (var i = 0; i < behaviors.length; i++) {
        this.__copyProperties(behaviors[i].properties, result);
      }
      // Now, get overlay properties.
      this.__copyProperties(this.overlay.properties, result);
      return result;
    },

    __copyProperties: function(properties, copyOverlay) {
      properties = properties || {};
      for (var propName in properties) {
        copyOverlay[propName] = properties[propName].type;
      }
    },

    __stampContent: function(element, content) {
      var element$ = Polymer.dom(element);
      var children = element$.children;
      // Remove all content
      for (var i = children.length - 1; i >= 0; i--) {
        element$.removeChild(children[i]);
      }
      // Add this content.
      for (var i = 0; i < content.length; i++) {
        element$.appendChild(content[i]);
      }
    }
  });
</script>
